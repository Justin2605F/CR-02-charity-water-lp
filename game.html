<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fill the Tank! — Gameplay</title>
  <link rel="stylesheet" href="game.css" />
</head>
<body>
  <main class="frame">

    <header class="topbar">
      <div class="brand">
        <span class="brand__text">charity: water</span>
      </div>

      <div class="timer">
        <span class="timer__label">Timer:</span>
        <span class="timer__value" id="timer">30</span><span class="timer__unit">s</span>
      </div>
    </header>

    <section class="score">
      <div class="score__label">Score:</div>
      <div class="score__value"><span id="liters">0</span> <span class="score__unit">Liters</span></div>
    </section>

    <section class="scene">

      <div class="quality">
        <div class="quality__dot" id="qualityDot" aria-hidden="true"></div>
        <div class="quality__text">Water: <span id="qualityText">CLEAN</span></div>
      </div>

      <div class="tank-wrap">
        <div class="tank">
          <div class="scribble" id="scribble" aria-hidden="true"></div>
          <div class="tank__fill" id="tankFill"></div>

          <div class="drop drop--1"></div>
          <div class="drop drop--2"></div>
          <div class="drop drop--3"></div>
          <div class="drop drop--4"></div>
          <div class="drop drop--5"></div>
        </div>

        <div class="tank-meta">
          <div class="tank-meta__text">
            Tank Fill: <span id="tankPct">0</span>%
          </div>

          <div class="bar">
            <div class="bar__fill" id="barFill"></div>
          </div>
        </div>
      </div>

      <div class="pump-area">
        <div class="pump" aria-hidden="true">
          <div class="pump__post"></div>
          <div class="pump__spout"></div>
          <div class="pump__bucket"></div>
        </div>

        <button class="pump-btn" id="pumpBtn">PUMP!</button>
      </div>

      <aside class="end" id="endPanel" aria-hidden="true">
        <h2 class="end__title">Time’s Up!</h2>
        <p class="end__text">You filled <b><span id="finalLiters">0</span> liters</b>.</p>

        <button class="end__btn" id="playAgainBtn">Play Again</button>
        <a class="end__btn end__btn--outline" href="https://www.charitywater.org" target="_blank" rel="noopener">
          Learn More
        </a>
      </aside>

    </section>

  </main>

  <audio id="pumpSound" preload="auto">
    <source src="pump.mp3" type="audio/mpeg">
  </audio>

  <script>
    let liters = 0;
    let timeLeft = 30;
    const GOAL_LITERS = 100;
    let isClean = true;

    const litersEl = document.getElementById("liters");
    const timerEl = document.getElementById("timer");
    const tankPctEl = document.getElementById("tankPct");
    const tankFillEl = document.getElementById("tankFill");
    const barFillEl = document.getElementById("barFill");
    const pumpBtn = document.getElementById("pumpBtn");

    const qualityDot = document.getElementById("qualityDot");
    const qualityText = document.getElementById("qualityText");

    const endPanel = document.getElementById("endPanel");
    const finalLiters = document.getElementById("finalLiters");
    const playAgainBtn = document.getElementById("playAgainBtn");

    const pumpSound = document.getElementById("pumpSound");
    const scribble = document.getElementById("scribble");
    const drops = document.querySelectorAll(".drop");

    function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

    function updateUI(){
      litersEl.textContent = liters;
      const pct = clamp(Math.round((liters / GOAL_LITERS) * 100), 0, 100);
      tankPctEl.textContent = pct;
      tankFillEl.style.height = pct + "%";
      barFillEl.style.width = pct + "%";
    }

    function setQuality(clean){
      isClean = clean;

      if (isClean){
        qualityDot.classList.remove("dirty");
        qualityText.textContent = "CLEAN";
      } else {
        qualityDot.classList.add("dirty");
        qualityText.textContent = "DIRTY";
      }

      drops.forEach(d => {
        if (isClean) d.classList.remove("dirty");
        else d.classList.add("dirty");
      });

      scribble.classList.remove("clean","dirty");
      scribble.classList.add(isClean ? "clean" : "dirty");
    }

    function startQualityCycle(){
      function flip(){
        setQuality(Math.random() > 0.45);
        const next = 1200 + Math.random() * 1300;
        if (timeLeft > 0) setTimeout(flip, next);
      }
      flip();
    }

    function startTimer(){
      const interval = setInterval(() => {
        timeLeft -= 1;
        timerEl.textContent = timeLeft;
        if (timeLeft <= 0){
          clearInterval(interval);
          endGame();
        }
      }, 1000);
    }

    function endGame(){
      pumpBtn.disabled = true;
      endPanel.classList.add("end--open");
      endPanel.setAttribute("aria-hidden","false");
      finalLiters.textContent = liters;
      localStorage.setItem("fill_tank_hi", String(liters));
    }

    pumpBtn.addEventListener("click", () => {
      if (timeLeft <= 0) return;

      if (pumpSound){
        pumpSound.currentTime = 0;
        pumpSound.play().catch(() => {});
      }

      if (isClean) liters += 1;
      else liters -= 2;

      liters = clamp(liters, 0, GOAL_LITERS);
      updateUI();
    });

    playAgainBtn.addEventListener("click", () => {
      liters = 0;
      timeLeft = 30;
      timerEl.textContent = timeLeft;
      pumpBtn.disabled = false;

      endPanel.classList.remove("end--open");
      endPanel.setAttribute("aria-hidden","true");

      setQuality(true);
      updateUI();
      startQualityCycle();
      startTimer();
    });

    setQuality(true);
    updateUI();
    startQualityCycle();
    startTimer();
  </script>
</body>
</html>